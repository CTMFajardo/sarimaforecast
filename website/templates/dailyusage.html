{% extends "base.html" %}
{% block title %} Daily Usage {% endblock %} 

{% block content %}
<br><br><br><br>
<br>

<br>

      
<div class="row">
  <!-- Left Column (col-md-8) -->
  <div class="col-md-8"><!--Start left-->
    <!-- Daily Usage Check Section -->
    <div class="card">
      <div class="card-header">
        <h2>Daily Usage</h2>
      </div>
      <div class="card-body">
        <form method="POST">
          <div>
            <label for="checkInventory">Check Daily Usage of Menu Items:</label>
            <input type="date" id="checkOrdered" name="checkOrdered" required>
            <button type="submit" class="btn btn-secondary" name="action" value="checkOrdered">Check Date</button>
            <br><br>
          </div>
        </form>
      </div>
    </div>
    <br>

    <!-- Display Usage Data Section -->
    {% if checkInv %}
    <div class="card">
      <h5 class="card-header">
        Menu ordered for {{ dateWords }}
      </h5>
      <div class="card-body">
        <table class="table table-borderless table-striped datatable">
          <thead>
            <tr>
              <th>Name</th>
              <th>Used Quantity</th>
            </tr>
          </thead>
          <tbody>
            {% for allInventory in checkInv %}
            <tr>
              <td>{{ allInventory.recipeItem }}</td>
              <td>{{ allInventory.quantity }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        
        <p>Posted by: {{ postedBy }}</p>
        {% if editDate %}
        <p>Edited on: {{ editDate }}</p>
        <p>Edited by: {{ editedBy }}</p>
        <p>Authorized by: {{ editAuth }}</p>
        {% endif %}
        
        <br>
        <button type="button" class="btn btn-secondary" data-toggle="modal" data-target="#authModal">Edit</button> 
        <p>*This needs Supervisor authorization</p>
      </div>  
    </div><br>
    {% endif %}

    <!-- Authorization Modal -->
    <div class="modal fade" id="authModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title fs-5" id="exampleModalLabel">Supervisor Authorization</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form method="POST" onsubmit="return confirm('Are you sure you want to submit?');">
              <div class="form-group">
                <table>
                  <tbody>                          
                    <tr>
                      <td><b>Username: </b></td>  
                      <td>      
                        <input
                          type="text"        
                          id="authName"
                          name="authName"
                          placeholder="Enter Username"/>
                      </td>
                    </tr>
                    <tr>
                      <td><b>Password: </b></td>
                      <td>
                        <input
                        type="password"     
                        id="authPass"
                        name="authPass"
                        placeholder="Supervisor Password"
                        />
                        <input type="hidden" id="currentDate" name="currentDate" value="{{ date }}">                 
                      </td>
                    </tr>
                  </tbody>
                </table>
                <br>      
                <div>
                  <button type="submit" class="btn btn-secondary" name="action" value="authSupervisor1">Authorize</button>
                </div>
              </div> 
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Input Usage Section -->
    <form method="POST" onsubmit="return confirm('Are you sure you want to submit?');">            
      {% if dailyList %}
      <div class="card">
        <div class="card-header">
          <h2>Input Menu ordered for {{ date }}</h2>
        </div>
        <div class="card-body">
          <table>
            <tbody>
              <th>Name</th>
              <th>Input Number of times Ordered</th>
              </tr>
              {% for allRecipe in dailyList %}
              <tr>  
                <td>{{ allRecipe.recipeName }}</td>
                <td>
                  <input type="number" id="{{ allRecipe.recipeName }}" name="{{ allRecipe.recipeName }}" 
                    placeholder="Quantity" size="1" min="0" oninput="this.value = 
                    !!this.value && Math.abs(this.value) >= 0 ? Math.abs(this.value) : null"/>
                  <input type="hidden" id="currentDate" name="currentDate" value="{{ date }}">
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          <p>Note: 'Ending Quantity' can not be empty.</p>
          <br>
          <button type="submit" class="btn btn-secondary" name="action" value="addAll">Save Menu Ordered</button>
        </div>
      </div><br>
      {% endif %}
    </form>

    <!-- Edit Usage Section -->
    <form method="POST" onsubmit="return confirm('Are you sure you want to submit?');">
      {% if editCurrentDate %}
      <div class="card">
        <div class="card-header">
          <h2>Edit Daily Usage</h2>
        </div>
        <div class="card-body">
          <table class="table">
            <thead class="thead-dark">
              <tr>   
                <th>Name</th>
                <th>Old Quantity</th>
                <th class="text-center">to </th>
                <th>New Quantity</th>
              </tr>
            </thead>    
            <tbody>
              {% for allInventory in editFilteredDate %}
              <tr>  
                <td>{{ allInventory.recipeItem }}
                  <input type="hidden" id="itemToEdit" name="itemToEdit" value="{{ allInventory.recipeItem }}">
                </td>
                <td>{{ allInventory.quantity }}</td>
                <td class="text-center"><p>></p></td>
                <td>
                  <input type="number" id="add{{ allInventory.recipeItem }}" name="add{{ allInventory.recipeItem }}" 
                  placeholder="New Quantity" size="1" min="0" oninput="this.value = 
                  !!this.value && Math.abs(this.value) >= 0 ? Math.abs(this.value) : null"/>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          <p>Note: New quantity must not be empty</p>
          <input type="hidden" id="dateToEdit" name="dateToEdit" value="{{ editCurrentDate }}">
          <input type="hidden" id="authUser" name="authUser" value="{{ authBy }}">
          <br> 
          <button type="submit" class="btn btn-secondary" name="action" value="editDailyUsage">Submit</button>  
        </div>
      </div><br>
      {% endif %}
    </form>

    <!-- Graph Section -->
    <form id="recipeUsageForm" onsubmit="event.preventDefault(); handleFormSubmit()">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Recipe Usage Analysis</h5>
          <div id="graph-loading" class="spinner-border text-secondary d-none" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
        <div class="card-body">
          <div class="row g-3 align-items-end mb-4">
            <div class="col-md-5">
              <label for="checkInventoryFrom" class="form-label">From Date</label>
              <input type="date" id="checkInventoryFrom" name="checkInventoryFrom" 
                    class="form-control" onchange="SetMinDate(this)" 
                    min="{{ minDate }}" max="{{ maxDate }}" required>
            </div>
            <div class="col-md-5">
              <label for="checkInventoryTo" class="form-label">To Date</label>
              <input type="date" id="checkInventoryTo" name="checkInventoryTo" 
                    class="form-control" onchange="SetMaxDate(this)" 
                    min="{{ minDate }}" max="{{ maxDate }}" required>
            </div>
            <div class="col-md-2">
              <button type="submit" class="btn btn-secondary w-100">
                <i class="bi bi-graph-up me-2"></i>Submit
              </button>
            </div>
          </div>
          
          <div class="border rounded p-3 bg-light">
            <div id="plotly-graph" style="width:100%; height:500px;"></div>
            <div id="graph-error" class="alert alert-danger mt-3 d-none"></div>
            <div id="graph-empty" class="alert alert-info mt-3 d-none">
              No data available for selected date range
            </div>
          </div>
        </div>
      </div>
    </form>
  </div><!--End left-->

  <!-- Right Column (col-md-4) -->
  <div class="col-md-4"><!--Start right-->
    <div class="card"> <!--Ordered Logs-->
      <h5 class="card-header">Empty Daily Ordered Dates</h5>
      <div class="card-body">
        {% if datesMenuUsedNoEntries %}   
        <div>                           
          <table class="table table-borderless datatable">                   
            <thead>
              <tr>
                <th scope="col">Daily Ordered Date</th>
              </tr>
            </thead>
            <tbody>
              {% for date in datesMenuUsedNoEntries %}
              <tr>
                <td><a href="{{ url_for('views.dailyusage', date=date) }}">{{ date }}</a></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <img src="https://hotidioms.files.wordpress.com/2018/01/green-thumb.png?w=242&h=242" alt="Green Thumb Image">
        <p>Database is updated!</p>
        {% endif %}
        <br>                        
        <p>*Note: If there is a date in the database that is not updated, it will appear here*</p>
      </div>
    </div>
  </div><!--End right-->
</div>
<br><br>
<br><br>

{% if user.position == "admin" %}
<div>
  <form method="POST"> <!--FOR TESTING ONLY!!-->
    <div class="card"> <!--For database import export-->
      <h5 class="card-header">TESTING PURPOSES</h5>
      <div class="card-body">
        <form method="POST" enctype="multipart/form-data" action="{{ url_for('views.handle_file_action') }}">
              <input type="file" name="file"> <!-- File input for uploading -->
              <br><br>
              <button type="submit" class="btn btn-secondary" name="action" value="importCSV">Import</button>
              <br><br>
              <button type="submit" class="btn btn-secondary" name="action" value="exportCSV">Export</button>
        </form>
      </div>
    </div>
  </form>
</div>
{% endif %}
<br> 

<!--
<button type="submit" class="btn btn-secondary" name="action" value="deleteAll">Delete Daily Inventory</button>
-->
<br>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
<script>
  // Initialize date pickers and form handler
  document.addEventListener('DOMContentLoaded', function() {
      initializeDatePickers();
  });
  
  function initializeDatePickers() {
      const fromDate = document.getElementById('checkInventoryFrom');
      const toDate = document.getElementById('checkInventoryTo');
      
      fromDate.min = "{{ minDate }}";
      fromDate.max = "{{ maxDate }}";
      toDate.min = "{{ minDate }}";
      toDate.max = "{{ maxDate }}";
      
      // Default to last 30 days
      if ("{{ maxDate }}") {
          const endDate = new Date("{{ maxDate }}");
          const startDate = new Date(endDate);
          startDate.setDate(startDate.getDate() - 30);
          
          toDate.valueAsDate = endDate;
          fromDate.valueAsDate = startDate > new Date("{{ minDate }}") ? startDate : new Date("{{ minDate }}");
      }
  }
  
  // Form submission handler
  async function handleFormSubmit() {
      const fromDate = document.getElementById('checkInventoryFrom').value;
      const toDate = document.getElementById('checkInventoryTo').value;
      
      if (!validateDates(fromDate, toDate)) return;
      
      try {
          showLoadingState(true);
          const data = await fetchGraphData(fromDate, toDate);
          handleGraphResponse(data);
      } catch (error) {
          showGraphError(error.message);
      } finally {
          showLoadingState(false);
      }
  }
  
  // Data fetching function
  async function fetchGraphData(fromDate, toDate) {
      const params = new URLSearchParams({ fromDate, toDate });
      const response = await fetch(`/recipe_usage_graph?${params}`);
      
      if (!response.ok) {
          const error = await response.json().catch(() => ({ error: 'Network error' }));
          throw new Error(error.error || 'Failed to load data');
      }
      
      return await response.json();
  }
  
  // Graph rendering function
  function renderPlotlyGraph(graphData) {
    // Process each trace to ensure proper naming
    const traces = graphData.data.map(trace => ({
        ...trace,
        line: { width: 2.5 },
        marker: { size: 8 },
        hovertemplate: `<b>${trace.name}</b><br>%{y} units on %{x|%b %d, %Y}<extra></extra>`,
        showlegend: true
    }));

    // Enhanced layout with better legend
    const layout = {
        ...graphData.layout,
        legend: {
            orientation: 'h',
            y: -0.3,
            x: 0.5,
            xanchor: 'center',
            font: {
                size: 12
            }
        },
        hoverlabel: {
            namelength: -1  // Show full name in hover
        }
    };

    Plotly.react('plotly-graph', traces, layout, {
        responsive: true,
        displayModeBar: true
    });
}
  
  // Helper functions
  function validateDates(fromDate, toDate) {
      if (!fromDate || !toDate) {
          showGraphError('Please select both start and end dates');
          return false;
      }
      
      if (new Date(fromDate) > new Date(toDate)) {
          showGraphError('End date must be after start date');
          return false;
      }
      
      return true;
  }
  
  function showLoadingState(show) {
      document.getElementById('graph-loading').classList.toggle('d-none', !show);
  }
  
  function showGraphError(message) {
      const errorEl = document.getElementById('graph-error');
      errorEl.textContent = message;
      errorEl.classList.remove('d-none');
      document.getElementById('graph-empty').classList.add('d-none');
  }
  
  function handleGraphResponse(data) {
      if (data.error) {
          throw new Error(data.error);
      }
      
      if (!data.data || data.data.length === 0) {
          document.getElementById('plotly-graph').innerHTML = '';
          document.getElementById('graph-empty').classList.remove('d-none');
          return;
      }
      
      document.getElementById('graph-error').classList.add('d-none');
      document.getElementById('graph-empty').classList.add('d-none');
      renderPlotlyGraph(data);
  }
  
  function SetMinDate(fromDate) {
      const toDate = document.getElementById('checkInventoryTo');
      toDate.min = fromDate.value;
      if (toDate.value && new Date(toDate.value) < new Date(fromDate.value)) {
          toDate.value = fromDate.value;
      }
  }
  
  function SetMaxDate(toDate) {
      const fromDate = document.getElementById('checkInventoryFrom');
      fromDate.max = toDate.value;
      if (fromDate.value && new Date(fromDate.value) > new Date(toDate.value)) {
          fromDate.value = toDate.value;
      }
  }
  </script>

{% endblock %}