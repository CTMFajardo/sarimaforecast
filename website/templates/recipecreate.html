{% extends "base.html" %}
{% block title %} Create Recipe {% endblock %} 

{% block content %}
<br><br><br><br>
<br>
<br>


<div class="row">
  <div class="col-md-8"><!--Left Side-->
    <div class="card">
      <div class="card-header">
        <h2>Create Recipe</h2>
      </div>
      <div class="card-body">
        <form method="POST">
          <br>
            <br><br>
            <div>
              <table>
                <tbody>                          
                    <tr>
                      <td><b>Recipe name: </b></td>  
                      <td>      
                        <input
                        type="text"
                        class="form-control"
                        id="recipeName"
                        name="recipeName"
                        placeholder="Enter Recipe name"
                        />
                      </td>
                    </tr>
                    <tr>
                      <td><b>Number of Servings: </b></td>
                      <td>
                        <input
                        type="number"
                        class="form-control"      
                        id="numberOfServings"
                        name="numberOfServings"
                        placeholder="Number of servings"
                        size="1" min="0" oninput="this.value = 
                        !!this.value && Math.abs(this.value) >= 0 ? Math.abs(this.value) : null"
                      />                 
                      </td>
                    </tr>
                </tbody>
              </table>
          </div>
          <div>
            <br><br>
            <!--
            <h5>Current Ingredients:</h5>
            <ul class="list-group list-group-flush" id="currentIngredients">
              {% for tempIngredients in tempIngredients %}
                <li class="list-group-item">  
                {{ tempIngredients.recipeIngredients }}
                {{ tempIngredients.recipeQuantity }} {{ tempIngredients.recipeUOM }} 
                <br>
                </li>
              {% endfor %}
              </ul>
              -->
              <h5>Current Ingredients:</h5>
              <ul class="list-group list-group-flush" id="currentIngredients" style="list-style-position: inside;">
                <!-- Will be populated -->
              </ul>
          </div>    
          <div class="form-group">
            <label for="ingredientListSelect">Ingredients: </label>
            <select class="form-control-sm" id="ingredientListSelect" name="ingredientListSelect">
              {% for allIngredients in allIngredients %}
              <option>{{ allIngredients.ingredientName }}</option>
              {% endfor %}
            </select>
            <input type="number" id="ingredientsQuantity" name="ingredientsQuantity" 
              placeholder="Quantity" size="1" min="0" oninput="this.value = 
              !!this.value && Math.abs(this.value) >= 0 ? Math.abs(this.value) : null"/>
            <select id="ingredientsUOM" name="ingredientsUOM">
              <option>pc/s</option>
              <option>mL</option>
              <option>L</option>
              <option>g</option>
              <option>kg</option>
              <option>cup/s</option>
              <option>serving</option>
            </select>
            <br>
            
            <div>
              <!--button type="submit" class="btn btn-secondary" name="action" value="addTemp">Add to ingredients</button>-->
              <button type="button" class="btn btn-secondary mt-2" id="addIngredientBtn">Add to ingredients</button>
            </div>
            
          </div>
          <br>   
            <br><br>
            <div>
              <button type="submit" class="btn btn-secondary" name="action" value="addRecipe">Add recipe</button>
              <button type="submit" class="btn btn-secondary" name="action" value="removeAll">Clear ingredients</button>
            </div>
        </form>   
      </div>
    </div>
  </div> <!--end left-->

  <div class="col-md-4"><!--Right side-->
    <div class="card">
      <div class="card-header">
        <h2>Recipe List</h2>
      </div>
      <div class="card-body">
        <form method="POST">
          <div>
              <br><br>
              <select class="form-control form-control-sm" id="recipeListSelect" name="recipeListSelect">
                  {% for allRecipe in distinctRecipe %}
                  <option>{{ allRecipe.recipeName }}</option>
                  {% endfor %}
              </select>
              <br>
              <div>
                  <button type="submit" class="btn btn-secondary" name="action" value="viewRecipe">View recipe</button>
                  <button type="submit" class="btn btn-secondary" name="action" value="removeRecipe">Delete recipe</button>
              </div>
          </div>
        </form>
        <br><br><br>
        <div>
          <h1>{{ recipeName }}</h1>
          
          <p> Number of Servings: {{ recipe.numberOfServings }}</p>
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>Quantity</th>
                <th>Unit</th>
                <th>Ingredient</th>
              </tr>
            </thead>
            <tbody>
              {% for filteredRecipeName in filteredRecipeName %}
              <tr>
                <td>{{ filteredRecipeName.quantity }}</td>
                <td>{{ filteredRecipeName.unitOfMeasure }}</td>
                <td>
                  <a href="#" data-bs-toggle="modal" data-bs-target="#ingredientModal" 
                     data-ingredient="{{ filteredRecipeName.ingredients }}"
                     data-quantity="{{ filteredRecipeName.quantity }}"
                     data-uom="{{ filteredRecipeName.unitOfMeasure }}">
                    {{ filteredRecipeName.ingredients }}
                  </a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div> <!--end right-->
</div>
<!-- Modal -->
<div class="modal fade" id="ingredientModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Ingredient Edit</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form method="POST">
          <!-- Hidden inputs -->
          <input type="hidden" id="ingredientNameHidden" name="ingredientName">
          <input type="hidden" id="recipeNameHidden" name="recipeName" value="{{ recipeName }}">
          
          <table class="table">
            <tbody>
              <tr>
                <td><b>Ingredient name: </b></td>
                <td>
                  <input type="text" class="form-control" 
                         id="ingredientNameDisplay" readonly>
                </td>
              </tr>
              <tr>
                <td><b>Quantity: </b></td>
                <td>
                  <div class="d-flex align-items-center gap-2">
                    <div class="flex-grow-1">
                      <input type="number" class="form-control" 
                             id="ingredientsQuantityEdit" name="ingredientsQuantityEdit"
                             placeholder="Quantity" min="0" required
                             oninput="this.value = !!this.value && Math.abs(this.value) >= 0 ? Math.abs(this.value) : null">
                    </div>
                    <div style="min-width: 120px;">
                      <select class="form-select h-100" 
                              id="ingredientsUOMEdit" name="ingredientsUOMEdit" required>
                        <option value="">Select unit</option>
                        <option value="pc/s">pc/s</option>
                        <option value="mL">mL</option>
                        <option value="L">L</option>
                        <option value="g">g</option>
                        <option value="kg">kg</option>
                        <option value="cup/s">cup/s</option>
                        <option value="serving">serving</option>
                      </select>
                    </div>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
          
          <div class="mt-3 text-end">
            <button type="submit" class="btn btn-secondary" name="action" value="recipeEdit">
              Save Changes
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  var modal = document.getElementById('ingredientModal');
  modal.addEventListener('show.bs.modal', function(event) {
    var link = event.relatedTarget;
    // Set the hidden input for form submission
    document.getElementById('ingredientNameHidden').value = link.getAttribute('data-ingredient');
    // Set the visible read-only field
    document.getElementById('ingredientNameDisplay').value = link.getAttribute('data-ingredient');
    // Set quantity and unit values
    document.getElementById('ingredientsQuantityEdit').value = link.getAttribute('data-quantity');
    document.getElementById('ingredientsUOMEdit').value = link.getAttribute('data-uom');
  });
});

// Populate the current ingredients list
document.addEventListener('DOMContentLoaded', function () {
  const addBtn = document.getElementById('addIngredientBtn');

  addBtn.addEventListener('click', function (e) {
    e.preventDefault();

    const ingredient = document.getElementById('ingredientListSelect').value;
    const quantity = document.getElementById('ingredientsQuantity').value;
    const uom = document.getElementById('ingredientsUOM').value;

    fetch('/add-temp-ingredient', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ ingredient, quantity, uom })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        const list = document.getElementById('currentIngredients');
        list.innerHTML = '';
        data.ingredients.forEach(item => {
          const li = document.createElement('li');
          li.classList.add('list-group-item');
          li.style.listStyleType = 'disc'; // ✅ bullet
          li.style.marginLeft = '20px';    // ✅ indent
          li.textContent = `${item.recipeIngredients} ${item.recipeQuantity} ${item.recipeUOM}`;
          list.appendChild(li);
        });
      } else {
        alert(data.message || 'Error adding ingredient');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('An unexpected error occurred.');
    });
  });
});
</script>
{% endblock %}